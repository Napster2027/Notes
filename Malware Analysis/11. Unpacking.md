## # `Unpacking using xdbg` -

High Level OverView :

- We’ll Run Until User Code a couple of times before we land at the Original Entry Point, where we begin to execute code inside of our malware.
- Set a breakpoint on **VirtualAlloc** and **VirtualProtect** run the command `bp VirtualAlloc` & `bp VirtualProtect` in x64dbg.
- Follow each arguments and eax until the last bp(EAX holds the base address of allocated memory).
- Example - last bp is VirtualAlloc with return of eax = 0x230000.
- Then dump 0x230000 memory region using ProcessHacker.

NOTE - ==this will be a Mapped Dump we need to unmap it next==.

## # `Unmapping Dumped File` -

In this example, we are going to dump a mapped version of the native Windows DLL kernel32.dll from memory using ProcessHacker and manually align it correctly on disk. After dumping the process memory of kernel32.dll from a random process and loading the file into PE-Bear, we can see that the file is not aligned correctly by browsing to the Imports section:

![[Pasted image 20230428223121.png]]

PE-Bear also displays the following values of the **IMAGE_SECTION_HEADERS** for the mapped version of the PE file:

| Raw Addr.	| Raw Size. | Virtual Addr. | Virtual Size. |
|-------------|-----------|---------------|--------------|
|400	|9AC00|	1000	|9AA8D|
|9B000	|6D800|	9C000	|6D7D8|
|108800	|1600	|10A000	|1980|
|109E00	|9800	|10C000	|9714|
|113600	|600	|116000	|528|
|113C00	|7C00	|117000	|7AB4|

In order to correctly align the PE file :

- Set the ==Raw Addr equals to Virtual Addr==. first.
- Fix the Virtual Size by calculating the difference between each Virtual Addr. The first value of Virtual Size will be ==9C000-1000 = 9B000== and go on.
- Now set the ==Raw size equal to Virtual Size==.
- In simple Raw Address should be equal to Virtual Address and Raw Size shoud be equal to Virtual Size.

Below is the correct alignment of the PE file after modification:

| Raw Addr.	| Raw Size. | Virtual Addr. | Virtual Size. |
|-------------|-----------|---------------|--------------|
|1000	|9B000|	1000	|9B000|
|9C000	|6E000|	9C000	|6E000|
|10A000	|2000	|10A000	|2000|
|10C000	|A000	|10C000	|A000|
|116000	|1000	|116000	|1000|
|117000	|0	|117000	|0|

Checking the Imports section again in PE-Bear provides us with complete and non-corrupted entries meaning the PE file should be correctly aligned :

![[Pasted image 20230428225938.png]]

You also have to fix Image base found under Optional Header.Image Base should be address of the memory dump.


[Unpacking & Fixing Corrupted Header](https://www.youtube.com/watch?v=WthvahlAYFY&ab_channel=OALabs)

